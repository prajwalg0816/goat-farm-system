<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ“Š Dashboard</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ================= BASE ================= */
body{
  font-family:"Segoe UI",Arial;
  background:linear-gradient(135deg,#fdfbfb,#ebedee);
  margin:0;
  padding:16px;
}
h1,h2{color:#2c5364}

/* Floating goat */
body::before{
  content:"ğŸ";
  position:fixed;
  top:12px;
  right:16px;
  font-size:36px;
  animation:floatGoat 3s ease-in-out infinite;
  pointer-events:none;
}
@keyframes floatGoat{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}

/* NAV */
nav{
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
nav a{
  text-decoration:none;
  color:#2c5364;
  font-weight:600;
  padding:8px 14px;
  border-radius:20px;
}
nav a:hover{background:#2c5364;color:#fff}

/* ================= LOADER ================= */
.loader{
  background:#fff;
  border-radius:16px;
  padding:20px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:12px;
}
.shimmer{
  height:16px;
  width:160px;
  background:linear-gradient(90deg,#eee,#ddd,#eee);
  background-size:200% 100%;
  animation:shimmer 1.2s infinite;
  border-radius:8px;
}
@keyframes shimmer{
  0%{background-position:200%}
  100%{background-position:-200%}
}

/* ================= GRID ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
}

/* ================= CARD ================= */
.card{
  background:#fff;
  border-radius:16px;
  padding:18px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  transition:.3s;
}
.card:hover{
  transform:translateY(-4px);
  box-shadow:0 14px 32px rgba(0,0,0,.12);
}
.num{
  font-size:30px;
  font-weight:bold;
}

/* ================= BUTTON ================= */
button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#2c5364;
  color:#fff;
}

/* ================= MOBILE ================= */
@media(max-width:600px){
  h1{font-size:20px}
}
</style>
</head>

<body>

<h1>ğŸ“Š Dashboard</h1>

<nav>
  <a href="owner.html">ğŸ‘‘ Owner</a>
  <a href="goats.html">ğŸ Goats</a>
  <a href="finance.html">ğŸ’° Finance</a>
  <a href="reports.html">ğŸ“‘ Reports</a>
</nav>

<!-- LOADING -->
<div class="loader" id="loader">
  <div class="shimmer"></div>
  <span>Fetching live dataâ€¦</span>
</div>

<!-- KPI CARDS -->
<div class="grid">
  <div class="card">
    <h3>Total Goats</h3>
    <div class="num" id="goatCount">0</div>
  </div>
  <div class="card">
    <h3>Total Income</h3>
    <div class="num" id="income">â‚¹0</div>
  </div>
  <div class="card">
    <h3>Total Expense</h3>
    <div class="num" id="expense">â‚¹0</div>
  </div>
  <div class="card">
    <h3>Net Profit</h3>
    <div class="num" id="profit">â‚¹0</div>
  </div>
</div>

<br>

<button onclick="loadDashboard()">ğŸ”„ Refresh Data</button>
<p id="updatedAt" style="color:#555"></p>

<br>

<!-- CHARTS -->
<div class="grid">
  <div class="card">
    <h2>ğŸ Goat Distribution</h2>
    <canvas id="goatChart"></canvas>
  </div>
  <div class="card">
    <h2>ğŸ’° Income vs Expense</h2>
    <canvas id="financeChart"></canvas>
  </div>
  <div class="card">
    <h2>ğŸ“ˆ Monthly Profit</h2>
    <canvas id="profitChart"></canvas>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const db = supabase.createClient(
  "https://jrrorjoxlwqanebnchui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impycm9yam94bHdxYW5lYm5jaHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDk5ODMsImV4cCI6MjA4NDAyNTk4M30.KgITXQJmA9TNw6lbHW94egKOW_gW6nPK5UViDNC5l5k"
);

let goatChartObj, financeChartObj, profitChartObj;

/* ================= LOAD DASHBOARD ================= */
async function loadDashboard(){
  loader.style.display="flex";

  const { data: goats } = await db.from("goats").select("*");
  const { data: finance } = await db.from("finance").select("*");

  loader.style.display="none";

  // KPI
  animate(goatCount, goats.length);
  let inc=0, exp=0, months={};
  finance.forEach(f=>{
    const m=f.entry_date.substring(0,7);
    months[m]=months[m]||{i:0,e:0};
    if(f.type==="Income"){inc+=+f.amount;months[m].i+=+f.amount}
    if(f.type==="Expense"){exp+=+f.amount;months[m].e+=+f.amount}
  });

  animate(income, inc, "â‚¹");
  animate(expense, exp, "â‚¹");
  animate(profit, inc-exp, "â‚¹");

  updatedAt.innerText="Last updated: "+new Date().toLocaleString();

  // Goat chart
  let male=0,female=0;
  goats.forEach(g=>{
    if(g.gender==="Male") male++;
    if(g.gender==="Female") female++;
  });

  if(goatChartObj) goatChartObj.destroy();
  goatChartObj=new Chart(goatChart,{
    type:"pie",
    data:{
      labels:["Male","Female"],
      datasets:[{data:[male,female],backgroundColor:["#3498db","#e84393"]}]
    }
  });

  // Finance chart
  if(financeChartObj) financeChartObj.destroy();
  financeChartObj=new Chart(financeChart,{
    type:"bar",
    data:{
      labels:Object.keys(months),
      datasets:[
        {label:"Income",data:Object.values(months).map(v=>v.i),backgroundColor:"#1d976c"},
        {label:"Expense",data:Object.values(months).map(v=>v.e),backgroundColor:"#e84118"}
      ]
    }
  });

  // Profit chart
  if(profitChartObj) profitChartObj.destroy();
  profitChartObj=new Chart(profitChart,{
    type:"line",
    data:{
      labels:Object.keys(months),
      datasets:[
        {label:"Profit",data:Object.values(months).map(v=>v.i-v.e),borderColor:"#2c5364",fill:false}
      ]
    }
  });
}

/* ================= COUNT ANIMATION ================= */
function animate(el,val,prefix=""){
  let c=0,step=Math.max(1,val/30);
  const t=setInterval(()=>{
    c+=step;
    if(c>=val){c=val;clearInterval(t)}
    el.innerText=prefix+Math.floor(c);
  },20);
}

/* INIT */
loadDashboard();
</script>

</body>
</html>
