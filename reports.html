<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üìë Reports</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  font-family:"Segoe UI",Arial;
  background:linear-gradient(135deg,#fdfbfb,#ebedee);
  margin:0;
  padding:16px;
}
h1,h2{color:#2c5364}

/* Floating goat */
body::before{
  content:"üêê";
  position:fixed;
  top:12px;
  right:16px;
  font-size:36px;
  animation:floatGoat 3s ease-in-out infinite;
  pointer-events:none;
}
@keyframes floatGoat{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}

/* NAV */
nav{
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
nav a{
  text-decoration:none;
  color:#2c5364;
  font-weight:600;
  padding:8px 14px;
  border-radius:20px;
}
nav a:hover{background:#2c5364;color:#fff}

/* CONTROLS */
.controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:14px;
}
select,input{
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  background:#2c5364;
  color:#fff;
}
.pdf{background:#1d976c}

/* CARD */
.card{
  background:#fff;
  border-radius:16px;
  padding:16px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  margin-bottom:20px;
}

/* TABLE */
.table-wrap{overflow-x:auto}
table{
  width:100%;
  min-width:1100px;
  border-collapse:collapse;
}
th{
  background:#2c5364;
  color:#fff;
  padding:10px;
}
td{
  padding:8px;
  border-bottom:1px solid #eee;
  text-align:center;
}

/* IMAGE LOADER */
.img-wrap{
  width:80px;
  height:80px;
  border-radius:10px;
  overflow:hidden;
  position:relative;
  margin:auto;
  background:#eee;
}
.img-wrap.loading::after{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(90deg,#eee,#ddd,#eee);
  background-size:200% 100%;
  animation:shimmer 1.2s infinite;
}
@keyframes shimmer{
  0%{background-position:200%}
  100%{background-position:-200%}
}
.img-wrap img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:none;
}
.img-wrap.loaded img{
  display:block;
}
.img-wrap.error::after{
  content:"‚ùå";
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  background:#f5f5f5;
}

/* PRINT */
@media print{
  nav,.no-print,body::before{display:none}
  body{background:#fff}
  .card{box-shadow:none}
}
</style>
</head>

<body>

<h1>üìë Reports</h1>

<nav class="no-print">
  <a href="owner.html">üëë Owner</a>
  <a href="dashboard.html">üìä Dashboard</a>
  <a href="goats.html">üêê Goats</a>
  <a href="finance.html">üí∞ Finance</a>
</nav>

<!-- GOAT REPORT -->
<div class="card" id="goatReport">
<h2>üêê Goat Reports</h2>

<div class="controls no-print">
  <select id="goatFilter">
    <option value="all">All Goats</option>
    <option value="adult_male">Adult Males</option>
    <option value="child_male">Child Males</option>
    <option value="adult_female">Adult Females</option>
    <option value="child_female">Child Females</option>
    <option value="pregnant">Pregnant Goats</option>
  </select>

  <input type="date" id="bornFrom">
  <input type="date" id="bornTo">

  <button onclick="loadGoats()">Apply</button>
  <button class="pdf" onclick="printGoats()">‚¨á Goat PDF</button>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Image</th>
  <th>ID</th>
  <th>Breed</th>
  <th>Gender</th>
  <th>DOB</th>
  <th>Age</th>
  <th>Status</th>
  <th>Life</th>
</tr>
</thead>
<tbody id="goatTable"></tbody>
</table>
</div>
</div>

<!-- FINANCE REPORT -->
<div class="card" id="financeReport">
<h2>üí∞ Finance Transactions</h2>

<div class="controls no-print">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="loadFinance()">Apply</button>
  <button class="pdf" onclick="printFinance()">‚¨á Finance PDF</button>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th>Date</th>
  <th>Type</th>
  <th>Category</th>
  <th>Amount</th>
  <th>Note</th>
</tr>
</thead>
<tbody id="financeTable"></tbody>
</table>
</div>
</div>

<script>
const db = supabase.createClient(
  "https://jrrorjoxlwqanebnchui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impycm9yam94bHdxYW5lYm5jaHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDk5ODMsImV4cCI6MjA4NDAyNTk4M30.KgITXQJmA9TNw6lbHW94egKOW_gW6nPK5UViDNC5l5k"
);

/* ====== DATE LIMIT ====== */
const today = new Date().toISOString().split("T")[0];
["bornFrom","bornTo","fromDate","toDate"].forEach(id=>{
  document.getElementById(id).max = today;
});

/* ====== AGE ====== */
function ageMonths(d){
  if(!d) return 0;
  const dob = new Date(d+"T00:00:00");
  const now = new Date();
  return (now.getFullYear()-dob.getFullYear())*12 + (now.getMonth()-dob.getMonth());
}

/* ====== LOAD GOATS (FIXED FILTERS) ====== */
async function loadGoats(){
  goatTable.innerHTML = "<tr><td colspan='8'>Loading...</td></tr>";

  const filter = goatFilter.value;
  const bf = bornFrom.value || "1900-01-01";
  const bt = bornTo.value || today;

  const { data, error } = await db
    .from("goats")
    .select("*")
    .gte("dob", bf)
    .lte("dob", bt);

  if(error){
    goatTable.innerHTML = "<tr><td colspan='8'>Error loading goats</td></tr>";
    return;
  }

  goatTable.innerHTML = "";

  data.forEach(g=>{
    const age = ageMonths(g.dob);
    let show = false;

    if(filter==="all") show = true;
    if(filter==="adult_male" && g.gender==="Male" && age>=6) show=true;
    if(filter==="child_male" && g.gender==="Male" && age<6) show=true;
    if(filter==="adult_female" && g.gender==="Female" && age>=6) show=true;
    if(filter==="child_female" && g.gender==="Female" && age<6) show=true;
    if(filter==="pregnant" && g.life_status==="Pregnant") show=true;

    if(!show) return;

    const imgHTML = g.image
      ? `
      <div class="img-wrap loading">
        <img src="${g.image}?width=160"
             loading="lazy"
             crossorigin="anonymous"
             onload="this.parentNode.className='img-wrap loaded'"
             onerror="this.parentNode.className='img-wrap error'">
      </div>`
      : "-";

    goatTable.innerHTML += `
<tr>
  <td>${imgHTML}</td>
  <td>${g.goat_id||"-"}</td>
  <td>${g.breed||"-"}</td>
  <td>${g.gender||"-"}</td>
  <td>${g.dob||"-"}</td>
  <td>${age}</td>
  <td>${g.status||"Live"}</td>
  <td>${g.life_status||"-"}</td>
</tr>`;
  });

  if(goatTable.innerHTML===""){
    goatTable.innerHTML="<tr><td colspan='8'>No records found</td></tr>";
  }
}

/* ====== LOAD FINANCE ====== */
async function loadFinance(){
  financeTable.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";

  const from = fromDate.value || "1900-01-01";
  const to = toDate.value || today;

  const { data, error } = await db
    .from("finance")
    .select("*")
    .gte("entry_date", from)
    .lte("entry_date", to)
    .order("entry_date",{ascending:false});

  if(error){
    financeTable.innerHTML="<tr><td colspan='5'>Error</td></tr>";
    return;
  }

  financeTable.innerHTML="";
  data.forEach(f=>{
    financeTable.innerHTML+=`
<tr>
  <td>${f.entry_date}</td>
  <td>${f.type}</td>
  <td>${f.category}</td>
  <td>‚Çπ${f.amount}</td>
  <td>${f.note||"-"}</td>
</tr>`;
  });
}

/* ====== WAIT FOR IMAGES BEFORE PRINT ====== */
function waitForImages(){
  const imgs = [...document.querySelectorAll(".img-wrap img")];
  return Promise.all(imgs.map(img=>{
    if(img.complete) return Promise.resolve();
    return new Promise(res=>{
      img.onload = img.onerror = res;
    });
  }));
}

async function printGoats(){
  financeReport.style.display="none";
  await waitForImages();
  window.print();
  financeReport.style.display="block";
}

async function printFinance(){
  goatReport.style.display="none";
  window.print();
  goatReport.style.display="block";
}

/* INIT */
loadGoats();
loadFinance();
</script>


</body>
</html>
