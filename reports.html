<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ“‘ Farm Reports</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ================= BASE ================= */
body{
  font-family:"Segoe UI",Arial;
  background:linear-gradient(135deg,#fdfbfb,#ebedee);
  margin:0;
  padding:16px;
  animation:fade .6s ease;
}
@keyframes fade{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}
h1,h2{color:#2c5364}

/* Floating goat */
body::before{
  content:"ğŸ";
  position:fixed;
  top:12px;
  right:16px;
  font-size:36px;
  animation:floatGoat 3s ease-in-out infinite;
  pointer-events:none;
}
@keyframes floatGoat{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}

/* ================= NAV ================= */
nav{
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
nav a{
  text-decoration:none;
  color:#2c5364;
  font-weight:600;
  padding:8px 14px;
  border-radius:20px;
}
nav a:hover{
  background:#2c5364;
  color:#fff;
}

/* ================= CONTROLS ================= */
.controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:16px;
}
input{
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
.filter{background:#1d976c;color:#fff}
.pdf{background:#2c5364;color:#fff}

/* ================= GRID ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
}

/* ================= CARD ================= */
.card{
  background:#fff;
  border-radius:16px;
  padding:18px;
  box-shadow:0 8px 22px rgba(0,0,0,.08);
}
.card h3{margin:0;color:#555}
.num{font-size:26px;font-weight:bold;margin-top:6px}

/* ALERTS */
.alert-low{
  border-left:6px solid #e84118;
  background:#fff5f5;
}
.alert-high{
  border-left:6px solid #fbc531;
  background:#fffbea;
}

/* ================= PRINT ================= */
@media print{
  nav,.controls,body::before{display:none}
  body{background:#fff}
  .card{box-shadow:none}
}
</style>
</head>

<body>

<h1>ğŸ“‘ Farm Reports</h1>

<nav>
  <a href="owner.html">ğŸ‘‘ Owner</a>
  <a href="dashboard.html">ğŸ“Š Dashboard</a>
  <a href="goats.html">ğŸ Goats</a>
  <a href="finance.html">ğŸ’° Finance</a>
</nav>

<!-- FILTERS -->
<div class="controls">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button class="filter" onclick="loadReports()">ğŸ” Apply Filter</button>
  <button class="pdf" onclick="window.print()">ğŸ“„ Export PDF</button>
</div>

<!-- SUMMARY -->
<div class="grid">
  <div class="card">
    <h3>Total Goats</h3>
    <div class="num" id="totalGoats">0</div>
  </div>
  <div class="card">
    <h3>Total Income</h3>
    <div class="num" id="income">â‚¹0</div>
  </div>
  <div class="card">
    <h3>Total Expense</h3>
    <div class="num" id="expense">â‚¹0</div>
  </div>
  <div class="card">
    <h3>Net Profit</h3>
    <div class="num" id="profit">â‚¹0</div>
  </div>
</div>

<br>

<!-- ALERTS -->
<div class="grid">
  <div class="card alert-low" id="profitAlert" style="display:none">
    âš ï¸ Profit is very low for selected period
  </div>
  <div class="card alert-high" id="expenseAlert" style="display:none">
    âš ï¸ Expenses are unusually high
  </div>
</div>

<br>

<!-- CHARTS -->
<div class="grid">
  <div class="card">
    <h2>ğŸ Goat Distribution</h2>
    <canvas id="goatChart"></canvas>
  </div>
  <div class="card">
    <h2>ğŸ’° Monthly Finance</h2>
    <canvas id="financeChart"></canvas>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const db = supabase.createClient(
  "https://jrrorjoxlwqanebnchui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impycm9yam94bHdxYW5lYm5jaHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDk5ODMsImV4cCI6MjA4NDAyNTk4M30.KgITXQJmA9TNw6lbHW94egKOW_gW6nPK5UViDNC5l5k"
);

let goatChartObj, financeChartObj;

/* ================= LOAD ================= */
async function loadReports(){
  const from = fromDate.value || "1900-01-01";
  const to = toDate.value || "2999-12-31";

  /* GOATS */
  const { data: goats } = await db.from("goats").select("*");
  totalGoats.innerText = goats.length;

  let male=0,female=0;
  goats.forEach(g=>{
    if(g.gender==="Male") male++;
    if(g.gender==="Female") female++;
  });

  if(goatChartObj) goatChartObj.destroy();
  goatChartObj = new Chart(goatChart,{
    type:"pie",
    data:{
      labels:["Male","Female"],
      datasets:[{data:[male,female],backgroundColor:["#3498db","#e84393"]}]
    }
  });

  /* FINANCE */
  const { data: finance } = await db
    .from("finance")
    .select("*")
    .gte("entry_date",from)
    .lte("entry_date",to);

  let inc=0,exp=0,months={};
  finance.forEach(f=>{
    const m=f.entry_date.substring(0,7);
    months[m]=months[m]||{i:0,e:0};
    if(f.type==="Income"){inc+=+f.amount;months[m].i+=+f.amount}
    if(f.type==="Expense"){exp+=+f.amount;months[m].e+=+f.amount}
  });

  income.innerText="â‚¹"+inc;
  expense.innerText="â‚¹"+exp;
  profit.innerText="â‚¹"+(inc-exp);

  profitAlert.style.display = (inc-exp)<5000 ? "block":"none";
  expenseAlert.style.display = exp>inc*0.7 ? "block":"none";

  if(financeChartObj) financeChartObj.destroy();
  financeChartObj=new Chart(financeChart,{
    type:"bar",
    data:{
      labels:Object.keys(months),
      datasets:[
        {label:"Income",data:Object.values(months).map(v=>v.i),backgroundColor:"#1d976c"},
        {label:"Expense",data:Object.values(months).map(v=>v.e),backgroundColor:"#e84118"}
      ]
    }
  });
}

/* INIT */
loadReports();
</script>

</body>
</html>
