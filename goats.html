<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Goat Management</title>
<link rel="stylesheet" href="style.css">

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<h2>üêê Goat Management</h2>

<input id="goat_id" placeholder="Goat ID"><br>
<input id="breed" placeholder="Breed"><br>

<select id="gender" onchange="toggleFemale()">
  <option value="">Select Gender</option>
  <option value="Male">Male</option>
  <option value="Female">Female</option>
</select><br>

<label>DOB</label><br>
<input type="date" id="dob"><br>

<select id="status">
  <option value="Live">Live</option>
  <option value="Dead">Dead</option>
  <option value="Sold">Sold</option>
</select><br>

<select id="life_status" style="display:none">
  <option value="">Female Life Status</option>
  <option value="Kid">Kid</option>
  <option value="Pregnant">Pregnant</option>
  <option value="Delivered">Delivered</option>
</select><br>

<input type="file" id="image" accept="image/*"><br><br>

<button onclick="addGoat()">Save Goat</button>

<p id="msg"></p>

<hr>

<h3>üìã Goat List</h3>

<table>
<thead>
<tr>
  <th>Image</th>
  <th>ID</th>
  <th>Breed</th>
  <th>Gender</th>
  <th>Age</th>
  <th>Status</th>
  <th>Life</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="goatTable"></tbody>
</table>

<script>
/* ================= SUPABASE CONFIG ================= */
const SUPABASE_URL = "https://jrrorjoxlwqanebnchui.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impycm9yam94bHdxYW5lYm5jaHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDk5ODMsImV4cCI6MjA4NDAyNTk4M30.KgITXQJmA9TNw6lbHW94egKOW_gW6nPK5UViDNC5l5k";

/* ‚úÖ IMPORTANT: use db, NOT supabase */
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================= FUNCTIONS ================= */

function toggleFemale(){
  document.getElementById("life_status").style.display =
    document.getElementById("gender").value === "Female"
    ? "block" : "none";
}

function calculateAge(dob){
  if(!dob) return null;
  const b = new Date(dob);
  const t = new Date();
  let age = t.getFullYear() - b.getFullYear();
  if (
    t.getMonth() < b.getMonth() ||
    (t.getMonth() === b.getMonth() && t.getDate() < b.getDate())
  ) age--;
  return age;
}

/* ================= LOAD GOATS ================= */
async function loadGoats(){
  const { data, error } = await db
    .from("goats")
    .select("*")
    .order("created_at", { ascending: false });

  const table = document.getElementById("goatTable");
  table.innerHTML = "";

  if(data){
    data.forEach(g => {
      table.innerHTML += `
<tr>
  <td>${g.image_url ? `<img src="${g.image_url}" width="50">` : "-"}</td>
  <td>${g.goat_id}</td>
  <td>${g.breed}</td>
  <td>${g.gender}</td>
  <td>${g.age ?? "-"}</td>
  <td>${g.status}</td>
  <td>${g.life_status ?? "-"}</td>
  <td><button onclick="deleteGoat('${g.id}')">‚ùå</button></td>
</tr>`;
    });
  }
}

/* ================= ADD GOAT ================= */
async function addGoat(){
  const msg = document.getElementById("msg");
  msg.style.color = "red";
  msg.innerText = "";

  const goatId = goat_id.value.trim();
  const breedVal = breed.value.trim();
  const genderVal = gender.value;

  if(!goatId || !breedVal || !genderVal){
    msg.innerText = "Goat ID, Breed and Gender required";
    return;
  }

  msg.style.color = "green";
  msg.innerText = "Saving goat...";

  let imageUrl = null;

  if(image.files.length > 0){
    const file = image.files[0];
    const fileName = Date.now() + "_" + file.name;

    const { error: uploadError } = await db
      .storage
      .from("goat-images")
      .upload(fileName, file);

    if(uploadError){
      msg.style.color = "red";
      msg.innerText = "Image upload failed";
      return;
    }

    imageUrl = db
      .storage
      .from("goat-images")
      .getPublicUrl(fileName).data.publicUrl;
  }

  const { error } = await db.from("goats").insert([{
    goat_id: goatId,
    breed: breedVal,
    gender: genderVal,
    dob: dob.value || null,
    age: calculateAge(dob.value),
    status: status.value,
    life_status: genderVal === "Female" ? life_status.value : null,
    image_url: imageUrl
  }]);

  if(error){
    msg.style.color = "red";
    msg.innerText = error.message;
  }else{
    msg.innerText = "Goat saved successfully ‚úÖ";
    clearForm();
    loadGoats();
  }
}

/* ================= DELETE ================= */
async function deleteGoat(id){
  if(confirm("Delete this goat?")){
    await db.from("goats").delete().eq("id", id);
    loadGoats();
  }
}

/* ================= CLEAR ================= */
function clearForm(){
  goat_id.value = "";
  breed.value = "";
  gender.value = "";
  dob.value = "";
  status.value = "Live";
  life_status.value = "";
  life_status.style.display = "none";
  image.value = "";
}

/* INIT */
loadGoats();
</script>

</body>
</html>
