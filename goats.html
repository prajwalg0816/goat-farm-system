<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Goat Management</title>

<style>
body{
  font-family: Arial;
  background:#f4f6f8;
  padding:20px;
}
nav a{
  margin-right:15px;
  font-weight:bold;
}
input, select, button{
  padding:8px;
  margin:6px 0;
}
button{
  background:#2c5364;
  color:#fff;
  border:none;
  cursor:pointer;
}
table{
  width:100%;
  background:#fff;
  border-collapse:collapse;
  margin-top:20px;
}
th, td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
img{
  border-radius:6px;
}
#msg{
  font-weight:bold;
  margin-top:10px;
}
</style>
</head>

<body>

<nav>
  <a href="dashboard.html">Dashboard</a>
  <a href="goats.html">Goats</a>
  <a href="finance.html">Finance</a>
</nav>

<h2>üêê Add Goat</h2>

<input id="goat_id" placeholder="Goat ID (required)"><br>
<input id="breed" placeholder="Breed (required)"><br>

<select id="gender" onchange="toggleFemale()">
  <option value="">Select Gender</option>
  <option>Male</option>
  <option>Female</option>
</select><br>

<label>Date of Birth</label><br>
<input type="date" id="dob"><br>

<select id="status">
  <option value="Live">Live</option>
  <option value="Dead">Dead</option>
  <option value="Sold">Sold</option>
</select><br>

<select id="life_status" style="display:none">
  <option value="">Female Life Status</option>
  <option value="Kid">Kid</option>
  <option value="Pregnant">Pregnant</option>
  <option value="Delivered">Delivered</option>
</select><br>

<label>Goat Image (optional)</label><br>
<input type="file" id="image" accept="image/*"><br><br>

<button onclick="addGoat()">Save Goat</button>

<p id="msg"></p>

<h2>üìã Goat List</h2>

<table>
<thead>
<tr>
  <th>Image</th>
  <th>ID</th>
  <th>Breed</th>
  <th>Gender</th>
  <th>Age</th>
  <th>Status</th>
  <th>Life Status</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="goatTable"></tbody>
</table>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ================= SUPABASE CONFIG ================= */
const supabaseUrl = "https://jrrorjoxlwqanebnchui.supabase.co";
const supabaseKey =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impycm9yam94bHdxYW5lYm5jaHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDk5ODMsImV4cCI6MjA4NDAyNTk4M30.KgITXQJmA9TNw6lbHW94egKOW_gW6nPK5UViDNC5l5k";

const supabase = supabase.createClient(supabaseUrl, supabaseKey);

/* ================= HELPERS ================= */
function toggleFemale(){
  life_status.style.display = gender.value === "Female" ? "block" : "none";
}

function calculateAge(dob){
  if(!dob) return null;
  const birth = new Date(dob);
  const today = new Date();
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

/* ================= LOAD GOATS ================= */
async function loadGoats(){
  const { data, error } = await supabase
    .from("goats")
    .select("*")
    .order("created_at", { ascending: false });

  goatTable.innerHTML = "";

  if(data){
    data.forEach(g=>{
      goatTable.innerHTML += `
<tr>
  <td>${g.image_url ? `<img src="${g.image_url}" width="60">` : "-"}</td>
  <td>${g.goat_id}</td>
  <td>${g.breed}</td>
  <td>${g.gender}</td>
  <td>${g.age ?? "-"}</td>
  <td>${g.status}</td>
  <td>${g.life_status ?? "-"}</td>
  <td><button onclick="deleteGoat('${g.id}')">‚ùå</button></td>
</tr>`;
    });
  }
}

/* ================= ADD GOAT ================= */
async function addGoat(){
  msg.style.color = "red";
  msg.innerText = "";

  if(!goat_id.value || !breed.value || !gender.value){
    msg.innerText = "Goat ID, Breed and Gender are required";
    return;
  }

  msg.style.color = "green";
  msg.innerText = "Saving goat...";

  let imageUrl = null;

  if(image.files.length > 0){
    const file = image.files[0];
    const fileName = Date.now() + "_" + file.name;

    const { error: uploadError } = await supabase
      .storage
      .from("goat-images")
      .upload(fileName, file);

    if(uploadError){
      msg.style.color = "red";
      msg.innerText = "Image upload failed";
      return;
    }

    imageUrl = supabase
      .storage
      .from("goat-images")
      .getPublicUrl(fileName).data.publicUrl;
  }

  const age = calculateAge(dob.value);

  const { error } = await supabase.from("goats").insert([{
    goat_id: goat_id.value,
    breed: breed.value,
    gender: gender.value,
    dob: dob.value || null,
    age: age,
    status: status.value,
    life_status: gender.value === "Female" ? life_status.value : null,
    image_url: imageUrl
  }]);

  if(error){
    msg.style.color = "red";
    msg.innerText = error.message;
  }else{
    msg.innerText = "Goat saved successfully ‚úÖ";
    clearForm();
    loadGoats();
  }
}

/* ================= DELETE GOAT ================= */
async function deleteGoat(id){
  if(confirm("Delete this goat?")){
    await supabase.from("goats").delete().eq("id", id);
    loadGoats();
  }
}

/* ================= CLEAR FORM ================= */
function clearForm(){
  goat_id.value = "";
  breed.value = "";
  gender.value = "";
  dob.value = "";
  status.value = "Live";
  life_status.value = "";
  life_status.style.display = "none";
  image.value = "";
}

/* INIT */
loadGoats();
</script>

</body>
</html>
