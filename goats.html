<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üêê Goat Management</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ===== LUXURY THEME ===== */
body{
  font-family: "Segoe UI", Arial;
  background: linear-gradient(135deg,#fdfbfb,#ebedee);
  padding:30px;
}
h2{
  color:#2c5364;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:25px;
  box-shadow:0 10px 30px rgba(0,0,0,.1);
  margin-bottom:30px;
}
input,select{
  padding:10px;
  margin:6px 0;
  width:100%;
  border-radius:8px;
  border:1px solid #ccc;
}
button{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
}
.save{
  background:linear-gradient(135deg,#1d976c,#93f9b9);
  color:#fff;
}
.edit{
  background:#fbc531;
  color:#000;
}
.delete{
  background:#e84118;
  color:#fff;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  background:#fff;
  border-radius:14px;
  overflow:hidden;
}
th{
  background:#2c5364;
  color:#fff;
  padding:12px;
}
td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:center;
}
img{
  border-radius:10px;
}
#msg{
  font-weight:bold;
  margin-top:10px;
}
</style>
</head>

<body>

<h2>üêê Goat Management</h2>

<div class="card">
  <input id="goat_id" placeholder="Goat ID">
  <input id="breed" placeholder="Breed">

  <select id="gender" onchange="toggleFemale()">
    <option value="">Gender</option>
    <option>Male</option>
    <option>Female</option>
  </select>

  <label>Date of Birth</label>
  <input type="date" id="dob">

  <select id="status">
    <option value="Live">Live</option>
    <option value="Dead">Dead</option>
    <option value="Sold">Sold</option>
  </select>

  <select id="life_status" style="display:none">
    <option value="">Female Life Status</option>
    <option>Kid</option>
    <option>Pregnant</option>
    <option>Delivered</option>
  </select>

  <input type="file" id="image">

  <button class="save" onclick="saveGoat()">Save / Update Goat</button>
  <p id="msg"></p>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Image</th>
  <th>ID</th>
  <th>Breed</th>
  <th>Gender</th>
  <th>DOB</th>
  <th>Age</th>
  <th>Status</th>
  <th>Life</th>
  <th>Edit</th>
  <th>Delete</th>
</tr>
</thead>
<tbody id="goatTable"></tbody>
</table>
</div>

<script>
/* ===== SUPABASE CONFIG ===== */
const db = supabase.createClient(
  "https://jrrorjoxlwqanebnchui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impycm9yam94bHdxYW5lYm5jaHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDk5ODMsImV4cCI6MjA4NDAyNTk4M30.KgITXQJmA9TNw6lbHW94egKOW_gW6nPK5UViDNC5l5k"
);

let editId = null;

/* ===== HELPERS ===== */
function toggleFemale(){
  life_status.style.display =
    gender.value === "Female" ? "block" : "none";
}

function calcAge(d){
  if(!d) return "-";
  const b = new Date(d);
  const t = new Date();
  let a = t.getFullYear() - b.getFullYear();
  if(t.getMonth()<b.getMonth() || 
    (t.getMonth()==b.getMonth() && t.getDate()<b.getDate())) a--;
  return a;
}

/* ===== LOAD GOATS ===== */
async function loadGoats(){
  const {data} = await db.from("goats").select("*").order("created_at",{ascending:false});
  goatTable.innerHTML="";
  data.forEach(g=>{
    goatTable.innerHTML += `
<tr>
<td>${g.image_url?`<img src="${g.image_url}" width="60">`:"-"}</td>
<td>${g.goat_id}</td>
<td>${g.breed}</td>
<td>${g.gender}</td>
<td>${g.dob ?? "-"}</td>
<td>${calcAge(g.dob)}</td>
<td>${g.status ?? "Live"}</td>
<td>${g.life_status ?? "-"}</td>
<td><button class="edit" onclick="editGoat('${g.id}',${JSON.stringify(g).replace(/"/g,'&quot;')})">‚úèÔ∏è</button></td>
<td><button class="delete" onclick="delGoat('${g.id}')">‚ùå</button></td>
</tr>`;
  });
}

/* ===== SAVE / UPDATE ===== */
async function saveGoat(){
  let imageUrl=null;

  if(image.files[0]){
    const f=image.files[0];
    const n=Date.now()+"_"+f.name;
    await db.storage.from("goat-images").upload(n,f);
    imageUrl=db.storage.from("goat-images").getPublicUrl(n).data.publicUrl;
  }

  const payload={
    goat_id:goat_id.value,
    breed:breed.value,
    gender:gender.value,
    dob:dob.value||null,
    status:status.value || "Live",
    life_status:gender.value==="Female"?life_status.value:null
  };
  if(imageUrl) payload.image_url=imageUrl;

  if(editId){
    await db.from("goats").update(payload).eq("id",editId);
    editId=null;
  }else{
    await db.from("goats").insert([payload]);
  }

  clearForm();
  loadGoats();
}

/* ===== EDIT ===== */
function editGoat(id,g){
  editId=id;
  goat_id.value=g.goat_id;
  breed.value=g.breed;
  gender.value=g.gender;
  dob.value=g.dob||"";
  status.value=g.status||"Live";
  life_status.value=g.life_status||"";
  toggleFemale();
}

/* ===== DELETE ===== */
async function delGoat(id){
  if(confirm("Delete this goat?")){
    await db.from("goats").delete().eq("id",id);
    loadGoats();
  }
}

/* ===== CLEAR ===== */
function clearForm(){
  goat_id.value="";
  breed.value="";
  gender.value="";
  dob.value="";
  status.value="Live";
  life_status.value="";
  image.value="";
}

/* INIT */
loadGoats();
</script>

</body>
</html>
