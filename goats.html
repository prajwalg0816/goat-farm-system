<!DOCTYPE html>
<html>
<head>
<title>Goat Management</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<h2>üêê Goat Management</h2>

<input id="goat_id" placeholder="Goat ID"><br>
<input id="breed" placeholder="Breed"><br>

<select id="gender" onchange="toggleFemale()">
  <option value="">Gender</option>
  <option>Male</option>
  <option>Female</option>
</select><br>

<input type="date" id="dob"><br>

<select id="status">
  <option>Live</option>
  <option>Dead</option>
  <option>Sold</option>
</select><br>

<select id="life_status" style="display:none">
  <option value="">Female Status</option>
  <option>Kid</option>
  <option>Pregnant</option>
  <option>Delivered</option>
</select><br>

<input type="file" id="image"><br><br>

<button onclick="addGoat()">Save Goat</button>
<p id="msg"></p>

<table>
<thead>
<tr>
<th>Image</th><th>ID</th><th>Breed</th><th>Gender</th>
<th>Age</th><th>Status</th><th>Life</th><th>‚ùå</th>
</tr>
</thead>
<tbody id="goatTable"></tbody>
</table>

<script>
const supabase = supabase.createClient(
  "https://jrrorjoxlwqanebnchui.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impycm9yam94bHdxYW5lYm5jaHVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0NDk5ODMsImV4cCI6MjA4NDAyNTk4M30.KgITXQJmA9TNw6lbHW94egKOW_gW6nPK5UViDNC5l5k"
);

function toggleFemale(){
  life_status.style.display = gender.value==="Female"?"block":"none";
}

function ageFromDOB(d){
  if(!d) return "";
  let b=new Date(d), t=new Date();
  let a=t.getFullYear()-b.getFullYear();
  if(t.getMonth()<b.getMonth()) a--;
  return a;
}

async function loadGoats(){
  const {data}=await supabase.from("goats").select("*").order("created_at",{ascending:false});
  goatTable.innerHTML="";
  data.forEach(g=>{
    goatTable.innerHTML+=`
<tr>
<td>${g.image_url?`<img src="${g.image_url}" width="50">`:"-"}</td>
<td>${g.goat_id}</td>
<td>${g.breed}</td>
<td>${g.gender}</td>
<td>${g.age??""}</td>
<td>${g.status}</td>
<td>${g.life_status??""}</td>
<td><button onclick="del('${g.id}')">‚ùå</button></td>
</tr>`;
  });
}

async function addGoat(){
  msg.innerText="Saving...";
  let img=null;
  if(image.files[0]){
    let f=image.files[0], name=Date.now()+"_"+f.name;
    await supabase.storage.from("goat-images").upload(name,f);
    img=supabase.storage.from("goat-images").getPublicUrl(name).data.publicUrl;
  }
  await supabase.from("goats").insert([{
    goat_id:goat_id.value,
    breed:breed.value,
    gender:gender.value,
    dob:dob.value||null,
    age:ageFromDOB(dob.value),
    status:status.value,
    life_status:gender.value==="Female"?life_status.value:null,
    image_url:img
  }]);
  msg.innerText="Saved ‚úÖ";
  loadGoats();
}

async function del(id){
  await supabase.from("goats").delete().eq("id",id);
  loadGoats();
}

loadGoats();
</script>

</body>
</html>
